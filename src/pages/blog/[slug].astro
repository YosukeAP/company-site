---
import {sanity} from '../../lib/sanityClient'
import {PortableText} from 'astro-portabletext'

export async function getStaticPaths() {
  // ここで全記事の slug を集めて静的に生成（ビルド時）
  const slugs: {slug: {current: string}}[] = await sanity.fetch(
    `*[_type=="post" && defined(slug.current)]{slug}`
  )
  return slugs.map(({slug}) => ({ params: { slug: slug.current } }))
}

const { slug } = Astro.params

// slug 1件を取得
const post = await sanity.fetch(
  `*[_type=="post" && slug.current==$slug][0]{
     title, body, _createdAt, _updatedAt
   }`,
  { slug }
)

if (!post) {
  throw new Error('Not found') // 404
}

// サイトのベースURL
const baseUrl = Astro.site?.href || 'https://example.com'; // デプロイ後に実際のURLに変更
const postUrl = `${baseUrl}/blog/${slug}`
const siteName = '会社サイト'

// 本文からテキストを抽出（OGP説明用）
const extractText = (body: any) => {
  if (typeof body === 'string') return body.slice(0, 200)
  if (Array.isArray(body)) {
    return body
      .filter((block: any) => block._type === 'block')
      .map((block: any) => block.children?.map((child: any) => child.text).join('') || '')
      .join(' ')
      .slice(0, 200) || ''
  }
  return ''
}

const description = extractText(post.body)

// JSON-LD構造化データ（Article スキーマ）
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": post.title,
  "datePublished": post._createdAt,
  "dateModified": post._updatedAt,
  "author": {
    "@type": "Organization",
    "name": siteName
  },
  "publisher": {
    "@type": "Organization",
    "name": siteName
  }
}
---

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{post.title} | ブログ</title>
    <meta name="description" content={description} />
    
    {/* OGP */}
    <meta property="og:type" content="article" />
    <meta property="og:title" content={post.title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={postUrl} />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:locale" content="ja_JP" />
    
    {/* Twitter Card */}
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={post.title} />
    <meta name="twitter:description" content={description} />
    
    {/* 構造化データ（JSON-LD） */}
    <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
  </head>
  <body style="font-family: system-ui,sans-serif; margin: 2rem auto; max-width: 720px;">
    <p><a href="/blog">← 一覧に戻る</a></p>
    <h1>{post.title}</h1>
    <small>更新日: {new Date(post._updatedAt).toLocaleDateString('ja-JP')}</small>

    <article style="margin-top:1rem;">
      <PortableText value={post.body} />
    </article>
  </body>
</html>
