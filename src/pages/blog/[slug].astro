---
import {sanity} from '../../lib/sanityClient'
import {PortableText} from 'astro-portabletext'
import imageUrlBuilder from '@sanity/image-url'

// 画像用ヘルパ
const builder = imageUrlBuilder(sanity)
const urlFor = (src:any) => builder.image(src)

export async function getStaticPaths() {
  // ここで全記事の slug を集めて静的に生成（ビルド時）
  const slugs: {slug: {current: string}}[] = await sanity.fetch(
    `*[_type=="post" && defined(slug.current)]{slug}`
  )
  return slugs.map(({slug}) => ({ params: { slug: slug.current } }))
}

const { slug } = Astro.params

// slug 1件を取得
const post = await sanity.fetch(
  `*[_type=="post" && slug.current==$slug][0]{
     title, body, _updatedAt
   }`,
  { slug }
)

if (!post) {
  throw new Error('Not found') // 404
}
---

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>{post.title} | ブログ</title>
  </head>
  <body style="font-family: system-ui,sans-serif; margin: 2rem auto; max-width: 720px;">
    <p><a href="/blog">← 一覧に戻る</a></p>
    <h1>{post.title}</h1>
    <small>更新日: {new Date(post._updatedAt).toLocaleDateString('ja-JP')}</small>

    <article style="margin-top:1rem;">
      <PortableText
        value={post.body}
        components={{
          // Portable Text内の画像表示（altに対応）
          types: {
            image: ({value}:any) => (
              <img
                src={urlFor(value).width(1200).fit('max').url()}
                alt={value?.alt || ''}
                style="max-width:100%; height:auto; border-radius:8px; margin:1rem 0;"
              />
            )
          }
        }}
      />
    </article>
  </body>
</html>
