---
import Base from '../../layouts/Base.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import {sanity} from '../../lib/sanityClient'
import {PortableText} from 'astro-portabletext'
import imageUrlBuilder from '@sanity/image-url'

// 画像用ヘルパ
const builder = imageUrlBuilder(sanity)
const urlFor = (src:any) => builder.image(src)

export async function getStaticPaths() {
  // ここで全記事の slug を集めて静的に生成（ビルド時）
  try {
    const slugs: {slug: {current: string}}[] = await sanity.fetch(
      `*[_type=="post" && defined(slug.current)]{slug}`
    )
    return slugs.map(({slug}) => ({ params: { slug: slug.current } }))
  } catch (error) {
    console.warn('Sanityからデータを取得できませんでした:', error)
    return []
  }
}

const { slug } = Astro.params

// slug 1件を取得
const post = await sanity.fetch(
  `*[_type=="post" && slug.current==$slug][0]{
     title, body, _createdAt, _updatedAt
   }`,
  { slug }
)

if (!post) {
  throw new Error('Not found') // 404
}

// サイトのベースURL
const baseUrl = Astro.site?.href || 'https://example.com'; // デプロイ後に実際のURLに変更
const postUrl = `${baseUrl}/blog/${slug}`

// 本文からテキストを抽出（OGP説明用）
const extractText = (body: any) => {
  if (typeof body === 'string') return body.slice(0, 200)
  if (Array.isArray(body)) {
    return body
      .filter((block: any) => block._type === 'block')
      .map((block: any) => block.children?.map((child: any) => child.text).join('') || '')
      .join(' ')
      .slice(0, 200) || ''
  }
  return ''
}

const description = extractText(post.body)

// パンくずリスト
const breadcrumbItems = [
  { label: 'ホーム', href: '/' },
  { label: 'ブログ', href: '/blog' },
  { label: post.title }
];

// JSON-LD構造化データ（Article スキーマ）
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": post.title,
  "description": description,
  "datePublished": post._createdAt,
  "dateModified": post._updatedAt,
  "author": {
    "@type": "Organization",
    "name": "株式会社テックソリューション",
    "url": baseUrl
  },
  "publisher": {
    "@type": "Organization",
    "name": "株式会社テックソリューション",
    "url": baseUrl,
    "logo": {
      "@type": "ImageObject",
      "url": `${baseUrl}/favicon.svg`
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": postUrl
  }
}
---

<Base title={`${post.title} | ブログ`} description={description} ogType="article" ogUrl={postUrl}>
  {/* 構造化データ（JSON-LD） */}
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
  
  <Breadcrumbs items={breadcrumbItems} />
  
  <div class="max-w-3xl mx-auto">
    
    <h1 class="text-4xl font-bold mb-4">{post.title}</h1>
    <time class="text-sm text-gray-500 block mb-8">
      更新日: {new Date(post._updatedAt).toLocaleDateString('ja-JP')}
    </time>

    <article class="prose prose-lg max-w-none">
      <PortableText value={post.body} />
    </article>
  </div>
</Base>
