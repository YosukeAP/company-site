---
import Layout from '../../layouts/Layout.astro';
import {sanity} from '../../lib/sanityClient'
import {PortableText} from 'astro-portabletext'
import imageUrlBuilder from '@sanity/image-url'

// 画像用ヘルパ
const builder = imageUrlBuilder(sanity)
const urlFor = (src:any) => builder.image(src)

export async function getStaticPaths() {
  // ここで全記事の slug を集めて静的に生成（ビルド時）
  const slugs: {slug: {current: string}}[] = await sanity.fetch(
    `*[_type=="post" && defined(slug.current)]{slug}`
  )
  return slugs.map(({slug}) => ({ params: { slug: slug.current } }))
}

const { slug } = Astro.params

// slug 1件を取得
const post = await sanity.fetch(
  `*[_type=="post" && slug.current==$slug][0]{
     title, body, _createdAt, _updatedAt
   }`,
  { slug }
)

if (!post) {
  throw new Error('Not found') // 404
}

// サイトのベースURL
const baseUrl = Astro.site?.href || 'https://example.com'; // デプロイ後に実際のURLに変更
const postUrl = `${baseUrl}/blog/${slug}`

// 本文からテキストを抽出（OGP説明用）
const extractText = (body: any) => {
  if (typeof body === 'string') return body.slice(0, 200)
  if (Array.isArray(body)) {
    return body
      .filter((block: any) => block._type === 'block')
      .map((block: any) => block.children?.map((child: any) => child.text).join('') || '')
      .join(' ')
      .slice(0, 200) || ''
  }
  return ''
}

const description = extractText(post.body)

// JSON-LD構造化データ（Article スキーマ）
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": post.title,
  "datePublished": post._createdAt,
  "dateModified": post._updatedAt,
  "author": {
    "@type": "Organization",
    "name": "会社サイト"
  },
  "publisher": {
    "@type": "Organization",
    "name": "会社サイト"
  }
}
---

<Layout title={`${post.title} | ブログ`} description={description} ogType="article" ogUrl={postUrl}>
  <div style="margin: 2rem auto; max-width: 720px; padding: 1rem;">
    {/* 構造化データ（JSON-LD） */}
    <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
    
    <p><a href="/blog">← 一覧に戻る</a></p>
    <h1>{post.title}</h1>
    <small>更新日: {new Date(post._updatedAt).toLocaleDateString('ja-JP')}</small>

    <article style="margin-top:1rem;">
      <PortableText
        value={post.body}
        components={{
          // Portable Text内の画像表示（altに対応）
          types: {
            image: ({value}:any) => (
              <img
                src={urlFor(value).width(1200).fit('max').url()}
                alt={value?.alt || ''}
                style="max-width:100%; height:auto; border-radius:8px; margin:1rem 0;"
              />
            )
          }
        }}
      />
    </article>
  </div>
</Layout>
