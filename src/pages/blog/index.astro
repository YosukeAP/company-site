---
import Base from '../../layouts/Base.astro';
import {sanity} from '../../lib/sanityClient'

// 最新順にタイトル・スラッグ・日付・本文の先頭テキスト
const posts = await sanity.fetch(`
  *[_type=="post"]|order(_createdAt desc){
    title,
    "slug": slug.current,
    _createdAt,
    body
  }
`).then((posts: any[]) => 
  posts.map((post: any) => ({
    ...post,
    excerpt: typeof post.body === 'string' 
      ? post.body.slice(0, 120)
      : post.body?.filter((block: any) => block._type === 'block')
          .map((block: any) => block.children?.map((child: any) => child.text).join('') || '')
          .join(' ')
          .slice(0, 120) || ''
  }))
)
---

<Base title="ブログ一覧 | 会社サイト" description="会社サイトのブログ記事一覧です。">
  <div>
    <h1 class="text-3xl font-bold mb-8">ブログ</h1>
    <ul class="space-y-6">
      {posts.map((p:any) => (
        <li class="p-6 border border-gray-200 rounded-lg hover:shadow-md transition-shadow">
          <a href={`/blog/${p.slug}`} class="block group">
            <h2 class="text-2xl font-semibold mb-2 group-hover:text-blue-600 transition-colors">
              {p.title}
            </h2>
            <time class="text-sm text-gray-500 block mb-3">
              {new Date(p._createdAt).toLocaleDateString('ja-JP')}
            </time>
            <p class="text-gray-700 line-clamp-3">{p.excerpt}…</p>
          </a>
        </li>
      ))}
    </ul>
  </div>
</Base>
